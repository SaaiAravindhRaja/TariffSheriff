name: CD Pipeline - EC2 Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: ap-southeast-1
  ECR_BACKEND_REPOSITORY: tariffsheriff-backend
  ECR_FRONTEND_REPOSITORY: tariffsheriff-frontend

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Check for file changes
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            backend:
              - 'apps/backend/**'
              - '.github/workflows/cd.yml'
            frontend:
              - 'apps/frontend/**'
              - '.github/workflows/cd.yml'

  build-backend:
    name: Build Backend Docker Image
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.backend == 'true'
    timeout-minutes: 25
    outputs:
      image: ${{ steps.image.outputs.image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'
      
      - name: Build JAR
        working-directory: apps/backend
        run: |
          echo "ðŸ“¦ Building backend JAR..."
          mvn -B clean package -DskipTests
          
          JAR_FILE=$(find target -name "*.jar" ! -name "*-original.jar" | head -n 1)
          if [ -z "$JAR_FILE" ]; then
            echo "âŒ JAR file not found!"
            exit 1
          fi
          echo "âœ… JAR built: $JAR_FILE"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_BACKEND_REPOSITORY }}
          tags: |
            type=sha,prefix=,format=short
            type=raw,value=latest
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: apps/backend
          file: apps/backend/Dockerfile
          push: true
          platforms: linux/amd64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  build-frontend:
    name: Build Frontend Docker Image
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.frontend == 'true'
    timeout-minutes: 25
    outputs:
      image: ${{ steps.image.outputs.image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '20.19.0'
          cache: 'npm'
      
      - name: Build frontend
        working-directory: apps/frontend
        run: |
          echo "ðŸ“¦ Building frontend..."
          npm ci
          npm run build
          
          if [ ! -d "dist" ]; then
            echo "âŒ Build output not found!"
            exit 1
          fi
          echo "âœ… Frontend built successfully"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_FRONTEND_REPOSITORY }}
          tags: |
            type=sha,prefix=,format=short
            type=raw,value=latest
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: apps/frontend
          file: apps/frontend/Dockerfile
          push: true
          platforms: linux/amd64
          build-args: |
            VITE_API_BASE_URL=/api
            VITE_AUTH0_DOMAIN=${{ secrets.AUTH0_DOMAIN }}
            VITE_AUTH0_CLIENT_ID=${{ secrets.AUTH0_CLIENT_ID }}
            VITE_AUTH0_AUDIENCE=${{ secrets.AUTH0_AUDIENCE }}
            VITE_AUTH0_REDIRECT_URI=https://tariffsheriff.app
            VITE_ENABLE_ANALYTICS=false
            VITE_ENABLE_ERROR_REPORTING=false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  deploy-to-ec2:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: |
      always() && 
      (needs.build-backend.result == 'success' || needs.build-frontend.result == 'success')
    timeout-minutes: 10
    environment:
      name: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to EC2 using ec2_run.sh
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DATABASE_USERNAME: ${{ secrets.DATABASE_USERNAME }}
          DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          DOMAIN: tariffsheriff.app
        run: |
          echo "ðŸš€ Deploying to EC2 with ec2_run.sh..."
          
          # Create /opt/tariffsheriff and write backend.env from GitHub Secrets
          ssh -i ~/.ssh/deploy_key $EC2_USER@$EC2_HOST "sudo mkdir -p /opt/tariffsheriff && sudo chown \$USER:\$USER /opt/tariffsheriff"
          ssh -i ~/.ssh/deploy_key $EC2_USER@$EC2_HOST "cat > /tmp/backend.env << 'ENVEOF'
          DATABASE_URL=${DATABASE_URL}
          DATABASE_USERNAME=${DATABASE_USERNAME}
          DATABASE_PASSWORD=${DATABASE_PASSWORD}
          JWT_SECRET=${JWT_SECRET}
          SPRING_PROFILES_ACTIVE=prod
          CORS_ALLOWED_ORIGIN_PATTERNS=https://tariffsheriff.app,https://www.tariffsheriff.app
          ENVEOF"
          ssh -i ~/.ssh/deploy_key $EC2_USER@$EC2_HOST "sudo mv /tmp/backend.env /opt/tariffsheriff/backend.env && sudo chmod 600 /opt/tariffsheriff/backend.env"
          
          # Copy ec2_run.sh and execute it with proper env vars
          scp -i ~/.ssh/deploy_key scripts/ec2_run.sh $EC2_USER@$EC2_HOST:/tmp/ec2_run.sh
          ssh -i ~/.ssh/deploy_key $EC2_USER@$EC2_HOST "chmod +x /tmp/ec2_run.sh && AWS_REGION='${{ env.AWS_REGION }}' BACKEND_REPO='${{ env.ECR_BACKEND_REPOSITORY }}' FRONTEND_REPO='${{ env.ECR_FRONTEND_REPOSITORY }}' BACKEND_ENV_FILE='/opt/tariffsheriff/backend.env' IMAGE_TAG='latest' DOMAIN='${DOMAIN}' HOST_CERTS_DIR='/opt/caddy/certs' /tmp/ec2_run.sh"
          
          echo "âœ… Remote execution complete"
      
      - name: Verify deployment
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          echo "ðŸ” Checking container status..."
          ssh -i ~/.ssh/deploy_key $EC2_USER@$EC2_HOST "docker ps --filter 'name=tariffsheriff' --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'"

  health-check:
    name: Post-Deployment Health Check
    runs-on: ubuntu-latest
    needs: [deploy-to-ec2]
    if: needs.deploy-to-ec2.result == 'success'
    timeout-minutes: 5
    steps:
      - name: Check backend health (via Caddy HTTPS)
        run: |
          echo "ðŸ¥ Checking backend health..."
          MAX_RETRIES=10
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s https://tariffsheriff.app/actuator/health > /dev/null 2>&1; then
              echo "âœ… Backend is healthy!"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "â³ Attempt $RETRY_COUNT/$MAX_RETRIES failed, retrying in 10s..."
            sleep 10
          done
          
          echo "âš ï¸  Backend health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Check frontend health (HTTPS)
        run: |
          echo "ðŸ¥ Checking frontend health..."
          MAX_RETRIES=10
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s https://tariffsheriff.app > /dev/null 2>&1; then
              echo "âœ… Frontend is healthy!"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "â³ Attempt $RETRY_COUNT/$MAX_RETRIES failed, retrying in 10s..."
            sleep 10
          done
          
          echo "âš ï¸  Frontend health check failed after $MAX_RETRIES attempts"
          exit 1

  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy-to-ec2, health-check]
    if: always()
    timeout-minutes: 5
    steps:
      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment:** ${{ needs.deploy-to-ec2.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Health Check:** ${{ needs.health-check.result }}" >> $GITHUB_STEP_SUMMARY
