version: "3.9"

services:
  backend:
    build:
      context: ./apps/backend
    image: tariffsheriff/backend:latest
    ports:
      - "8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: dev
      SERVER_PORT: 8080
      # Comma-separated list (no spaces) of allowed origins for CORS
      CORS_ALLOWED_ORIGIN_PATTERNS: ${CORS_ALLOWED_ORIGIN_PATTERNS:-http://localhost:*}
    # Read secrets from /run/secrets/* and export as envs before launching Java
    entrypoint:
      - sh
      - -c
      - |
        export DATABASE_URL="$(cat /run/secrets/database_url)" && \
        export DATABASE_USERNAME="$(cat /run/secrets/database_username)" && \
        export DATABASE_PASSWORD="$(cat /run/secrets/database_password)" && \
        export JWT_SECRET="$(cat /run/secrets/jwt_secret)" && \
        exec java $JAVA_OPTS -jar /app/app.jar
    secrets:
      - database_url
      - database_username
      - database_password
      - jwt_secret

  frontend:
    build:
      context: ./apps/frontend
      args:
        # NOTE: Vite reads VITE_* at build time. Your frontend Dockerfile must
        # export this into the build environment for it to take effect.
        - VITE_API_BASE_URL=${VITE_API_BASE_URL:-http://localhost:8080/api}
        - VITE_AUTH0_DOMAIN=${VITE_AUTH0_DOMAIN:-dev-z2vxmgm44x0y3h8l.us.auth0.com}
        - VITE_AUTH0_CLIENT_ID=${VITE_AUTH0_CLIENT_ID:-f61l4L8kz0ot0YuQGbi7LXIVW8OGmxvs}
        - VITE_AUTH0_REDIRECT_URI=${VITE_AUTH0_REDIRECT_URI:-http://localhost:3000}
        - VITE_AUTH0_AUDIENCE=${VITE_AUTH0_AUDIENCE:-https://api.tariffsheriff.com}
        - VITE_ENABLE_ANALYTICS=${VITE_ENABLE_ANALYTICS:-false}
        - VITE_ENABLE_ERROR_REPORTING=${VITE_ENABLE_ERROR_REPORTING:-false}
    image: tariffsheriff/frontend:latest
    ports:
      - "80:80"
    depends_on:
      - backend

networks:
  default:
    name: tariffsheriff-net

secrets:
  database_url:
    file: ./secrets/database_url.txt
  database_username:
    file: ./secrets/database_username.txt
  database_password:
    file: ./secrets/database_password.txt
  jwt_secret:
    file: ./secrets/jwt_secret.txt

